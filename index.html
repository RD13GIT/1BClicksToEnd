<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Global Counter</title>
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
      :root {
        color-scheme: dark;
        --slots: 8;
        --digit-w: 64px;
        --digit-h: 5rem;
        --gap: 16px;
        --panel-pad: 14px;
        --bg: #171717; --grid: #202020; --panel-bg: #242424; --slot-bg: #1b1b1b; --slot-border: #4a4a4a; --digit: #8b5cf6;
      }
      html, body { height: 100%; }
      * { box-sizing: border-box; }
      body {
        margin: 0; display: grid; place-items: center; color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Ubuntu, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
        background-size: 40px 40px;
      }
      .stage { display: grid; justify-items: center; gap: 16px; width: 100%; }
      .title { opacity: 0.85; font-size: 14px; letter-spacing: 0.08em; text-transform: uppercase; margin-top: 8px; }
      .offline { background: #3a2323; border: 1px solid #5c2a2a; color: #fecaca; padding: 8px 12px; border-radius: 8px; font-size: 13px; width: min(900px, 92vw); text-align: center; }

      /* Layout: leaderboard left, counter+controls right */
      .columns { display: grid; gap: 28px; align-items: start; grid-template-columns: 1fr; width: 100%; }
      @media (min-width: 900px) { .columns { grid-template-columns: minmax(260px, 340px) auto; justify-content: center; column-gap: 40px; } }
      .main { display: grid; gap: 16px; justify-items: center; }

      /* Leaderboard */
      .leaderboard { display: grid; gap: 12px; width: 100%; max-width: 340px; justify-self: end; }
      .lb-title { opacity: 0.8; font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase; text-align: left; }
      .lb-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
      .lb-row { display: grid; grid-template-columns: 36px minmax(0, 14ch) auto; align-items: center; gap: 12px;
        padding: 10px 14px; background: var(--slot-bg); border: 2px solid var(--slot-border);
        box-shadow: inset 0 0 0 2px var(--slot-bg), 0 4px 14px rgba(0,0,0,.35); border-radius: 12px; }
      .lb-rank { display: grid; place-items: center; width: 28px; height: 28px; border-radius: 8px; background: #2a2a2a; color: #cbd5e1; font-size: 12px; font-weight: 700; }
      .lb-name { min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #e5e7eb; font-size: 16px; max-width: 14ch; }
      .lb-count { font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: var(--digit); font-weight: 600; font-size: 18px; text-align: right; min-width: 5ch; }
      .empty { opacity: .7; text-align: center; padding: 8px 0; }

      /* Counter visuals */
      .counter-wrap { position: relative; display: inline-block; }
      /* Use your rectangle image for the panel background with a fallback color */
      .panel {
        position: absolute; inset: calc(-1 * var(--panel-pad));
        background: var(--panel-bg) url('/images/background.png') center/cover no-repeat;
        border-radius: 16px 16px 0 0; z-index: 0;
      }
      .counter { position: relative; z-index: 1; display: flex; gap: var(--gap); }

      /* Each digit slot uses your slot.png */
      .slot {
        position: relative; width: var(--digit-w); height: var(--digit-h);
        background: var(--slot-bg) url('/images/slot.png') center/cover no-repeat;
        border-radius: 14px; border: 2px solid var(--slot-border);
        box-shadow: inset 0 0 0 2px rgba(0,0,0,0.25), 0 4px 14px rgba(0,0,0,.35);
        overflow: hidden;
      }

      .reel { position: absolute; top: 0; left: 0; right: 0; transform: translateY(calc(-1 * var(--i, 10) * var(--digit-h))); transition: transform var(--t, 900ms) cubic-bezier(.22,.8,.15,1); will-change: transform; }
      .num {
        display: grid; place-items: center; height: var(--digit-h); width: 100%;
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-weight: 600; font-size: 2.2rem; line-height: 1; font-variant-numeric: tabular-nums;
        color: var(--digit); text-shadow: 0 0 12px rgba(139, 92, 246, .25), 0 1px 0 rgba(0,0,0,.4);
      }
      @media (prefers-reduced-motion: reduce) { .reel { transition-duration: 0ms !important; } }

      .cta-button { display: block; box-sizing: border-box; width: auto; padding: 0.9rem 1.2rem; background: #242424; color: #fff; border: none; border-radius: 0 0 8px 8px; font: inherit; cursor: pointer; text-align: center; }
      .cta-button:hover { background: #2a2a2a; }
      .cta-button:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }

      .name-settings { display: grid; gap: 10px; width: auto; }
      .name-form { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
      .name-input { padding: 10px 12px; border-radius: 10px; border: 2px solid var(--slot-border); background: #202020; color: #e5e7eb; font: inherit; }
      .name-save { padding: 10px 14px; border-radius: 10px; border: 2px solid var(--slot-border); background: #2a2a2a; color: #fff; font: inherit; cursor: pointer; }
      .name-save:hover { background: #333; }
      .name-status { min-height: 1.2em; font-size: 12px; opacity: 0.8; }

      /* Admin panel (hidden by default, shown only if /api/me.admin === true) */
      .admin-panel { display: grid; gap: 12px; width: auto; }
      .admin-card { display: grid; gap: 12px; padding: 12px 14px; background: rgba(255,255,255,0.03); border: 2px solid var(--slot-border); border-radius: 12px; box-shadow: inset 0 0 0 2px rgba(0,0,0,0.2), 0 4px 14px rgba(0,0,0,.35); }
      .admin-title { opacity: 0.8; font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase; }
      .admin-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; align-items: center; }
      .admin-actions { display: flex; flex-wrap: wrap; gap: 8px; }
      .admin-input { padding: 8px 10px; border-radius: 10px; border: 2px solid var(--slot-border); background: #202020; color: #e5e7eb; font: inherit; }
      .btn { padding: 8px 12px; border-radius: 10px; border: 2px solid var(--slot-border); background: #2a2a2a; color: #fff; cursor: pointer; }
      .btn:hover { background: #333; }
      .btn.danger { background: #3a2323; border-color: #5c2a2a; }
    </style>
  </head>
  <body>
    <div class="stage">
      <div class="title">GLOBAL CLICKS</div>
      <div id="offline" class="offline" hidden>You're offline. Trying to reconnect…</div>

      <div class="columns">
        <!-- Left: Leaderboard -->
        <section class="leaderboard" id="leaderboard">
          <div class="lb-title">Leaderboard</div>
          <ol class="lb-list" id="lb-list"></ol>
        </section>

        <!-- Right: Counter + controls -->
        <div class="main">
          <div class="counter-wrap">
            <div class="panel" aria-hidden="true"></div>
            <div id="counter" class="counter" aria-label="8-slot counter"></div>
          </div>

          <button id="inc" class="cta-button" type="button">+1</button>

          <section class="name-settings" id="name-settings">
            <form id="name-form" class="name-form" autocomplete="off">
              <input id="name-input" class="name-input" type="text" placeholder="Your name" maxlength="32" />
              <button class="name-save" id="name-save" type="submit">Save name</button>
            </form>
            <div class="name-status" id="name-status"></div>
          </section>

          <!-- Admin panel (only shown if /api/me.admin === true) -->
          <section class="admin-panel" id="admin-panel" hidden>
            <div class="admin-card">
              <div class="admin-title">Admin</div>

              <div class="admin-grid">
                <div>Global count</div><div id="admin-gc">–</div>
                <div>Leaderboard size</div><div id="admin-lbsize">–</div>
              </div>

              <div class="admin-actions">
                <input id="admin-set-value" class="admin-input" type="number" min="0" step="1" placeholder="Set count…" style="width: 160px" />
                <button id="admin-apply-set" class="btn">Apply</button>

                <input id="admin-add-delta" class="admin-input" type="number" min="1" step="1" placeholder="Add…" style="width: 120px" />
                <button id="admin-apply-add" class="btn">Add to count</button>
              </div>

              <div class="admin-title">User tools</div>
              <div class="admin-actions">
                <input id="admin-user-id" class="admin-input" type="text" placeholder="User ID (cid)" style="width: 240px" />
                <input id="admin-user-delta" class="admin-input" type="number" step="1" placeholder="Δ clicks" style="width: 120px" />
                <button id="admin-user-add" class="btn">Add clicks</button>
                <button id="admin-user-remove" class="btn">Remove clicks</button>
                <button id="admin-user-ban" class="btn danger">Ban</button>
                <button id="admin-user-unban" class="btn">Unban</button>
                <button id="admin-user-purge" class="btn danger">Purge from LB</button>
              </div>

              <div class="admin-status" id="admin-status"></div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      const SLOTS = 8, BASE = 900, PER_STEP = 300, COPIES = 3, COPY_SIZE = 10, MIDDLE_OFFSET = COPY_SIZE;

      const counterEl = document.getElementById('counter');
      const offlineBar = document.getElementById('offline');
      const incBtn = document.getElementById('inc');

      const adminPanel = document.getElementById('admin-panel');
      const adminGcEl = document.getElementById('admin-gc');
      const adminLbSizeEl = document.getElementById('admin-lbsize');
      const adminStatus = document.getElementById('admin-status');
      const adminSetValue = document.getElementById('admin-set-value');
      const adminApplySet = document.getElementById('admin-apply-set');
      const adminAddDelta = document.getElementById('admin-add-delta');
      const adminApplyAdd = document.getElementById('admin-apply-add');
      const adminUserId = document.getElementById('admin-user-id');
      const adminUserDelta = document.getElementById('admin-user-delta');
      const adminUserAdd = document.getElementById('admin-user-add');
      const adminUserRemove = document.getElementById('admin-user-remove');
      const adminUserBan = document.getElementById('admin-user-ban');
      const adminUserUnban = document.getElementById('admin-user-unban');
      const adminUserPurge = document.getElementById('admin-user-purge');

      // Build reels
      const reels = [];
      for (let i = 0; i < SLOTS; i++) {
        const slot = document.createElement('div'); slot.className = 'slot';
        const reel = document.createElement('div'); reel.className = 'reel';
        for (let c = 0; c < COPIES; c++) for (let d = 0; d < 10; d++) {
          const el = document.createElement('div'); el.className = 'num'; el.textContent = d; reel.appendChild(el);
        }
        const baseline = MIDDLE_OFFSET + 0; reel.style.setProperty('--i', baseline); reel.dataset.index = String(baseline);
        slot.appendChild(reel); counterEl.appendChild(slot); reels.push(reel);
      }

      function animateReel(reel, targetDigit) {
        const curIdx = Number(reel.dataset.index || (MIDDLE_OFFSET + 0));
        const curVal = curIdx % 10;
        const forward = (targetDigit - curVal + 10) % 10;
        const backward = (curVal - targetDigit + 10) % 10;
        let nextIdx, steps;
        if (forward <= backward) { nextIdx = curIdx + forward; steps = forward; }
        else { nextIdx = curIdx - backward; steps = backward; }
        const dur = BASE + PER_STEP * steps;
        reel.style.setProperty('--t', dur + 'ms'); reel.style.setProperty('--i', nextIdx); reel.dataset.index = String(nextIdx);
        const onEnd = (e) => {
          if (e.propertyName !== 'transform') return;
          reel.removeEventListener('transitionend', onEnd);
          const baseline = MIDDLE_OFFSET + (nextIdx % 10);
          reel.style.setProperty('--t', '0ms'); reel.style.setProperty('--i', baseline); void reel.offsetWidth; reel.style.removeProperty('--t');
          reel.dataset.index = String(baseline);
        };
        reel.addEventListener('transitionend', onEnd);
      }

      let currentValue = 0;
      function setNumber(n, { animate = true } = {}) {
        const next = Math.max(0, Math.floor(n));
        const curStr = String(currentValue).padStart(SLOTS, '0');
        const nextStr = String(next).padStart(SLOTS, '0');
        for (let i = 0; i < SLOTS; i++) {
          const reel = reels[i];
          const fromDigit = +curStr[i]; const toDigit = +nextStr[i];
          if (!animate) {
            const baseline = MIDDLE_OFFSET + toDigit;
            reel.style.setProperty('--t', '0ms'); reel.style.setProperty('--i', baseline); reel.dataset.index = String(baseline);
            void reel.offsetWidth; reel.style.removeProperty('--t');
          } else if (fromDigit !== toDigit) {
            animateReel(reel, toDigit);
          }
        }
        currentValue = next;
      }

      // Match panel width (button, name, admin)
      (function sizeToPanel() {
        const panel = document.querySelector('.panel');
        const wrap = document.querySelector('.counter-wrap');
        const elements = [document.querySelector('.cta-button'), document.querySelector('#name-settings'), document.querySelector('#admin-panel')].filter(Boolean);
        if (!panel || !wrap || !elements.length) return;
        const setWidth = () => {
          const w = Math.ceil(panel.getBoundingClientRect().width);
          elements.forEach(el => el.style.width = w + 'px');
        };
        window.addEventListener('load', setWidth);
        window.addEventListener('resize', setWidth);
        if ('ResizeObserver' in window) new ResizeObserver(setWidth).observe(wrap);
      })();

      // Offline-aware fetch
      function setOnlineState(online) {
        offlineBar.hidden = online;
        incBtn.disabled = !online;
        if (!adminPanel.hidden) {
          adminApplySet.disabled = !online;
          adminApplyAdd.disabled = !online;
          adminUserAdd.disabled = !online;
          adminUserRemove.disabled = !online;
          adminUserBan.disabled = !online;
          adminUserUnban.disabled = !online;
          adminUserPurge.disabled = !online;
        }
      }
      window.addEventListener('online', async () => {
        setOnlineState(true);
        await Promise.allSettled([refreshCount(), refreshLeaderboard()]);
        if (!adminPanel.hidden) await loadAdminStats();
      });
      window.addEventListener('offline', () => setOnlineState(false));

      async function fetchJSON(url, opts = {}) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 10000);
        try {
          const res = await fetch(url, { ...opts, signal: ctrl.signal });
          const text = await res.text();
          let data = {};
          try { data = text ? JSON.parse(text) : {}; } catch {}
          if (!res.ok) throw new Error(data?.error || res.statusText || 'Request failed');
          return data;
        } finally { clearTimeout(t); }
      }

      // API calls
      async function refreshCount() {
        try {
          const { count } = await fetchJSON('/api/count');
          setOnlineState(true);
          if (count !== currentValue) setNumber(count, { animate: true });
        } catch (e) { console.error('poll error (count)', e); }
      }

      const lbList = document.getElementById('lb-list');
      function renderLeaderboard(leaders = []) {
        lbList.innerHTML = '';
        if (!leaders.length) {
          const li = document.createElement('li'); li.className = 'empty'; li.textContent = 'No entries yet.'; lbList.appendChild(li); return;
        }
        leaders.slice(0, 10).forEach((row, idx) => {
          const li = document.createElement('li'); li.className = 'lb-row';
          const rank = document.createElement('div'); rank.className = 'lb-rank'; rank.textContent = idx + 1;
          const name = document.createElement('div'); name.className = 'lb-name'; name.textContent = row.name || 'Anonymous';
          const count = document.createElement('div'); count.className = 'lb-count'; count.textContent = (row.count ?? 0).toLocaleString();
          li.append(rank, name, count); lbList.appendChild(li);
        });
      }
      async function refreshLeaderboard() {
        try {
          const { leaders } = await fetchJSON('/api/leaderboard');
          setOnlineState(true);
          renderLeaderboard(Array.isArray(leaders) ? leaders : []);
        } catch (e) { console.error('poll error (leaderboard)', e); }
      }

      incBtn.addEventListener('click', async () => {
        incBtn.disabled = true;
        try {
          const { count } = await fetchJSON('/api/increment', { method: 'POST' });
          setOnlineState(true);
          setNumber(count, { animate: true });
          refreshLeaderboard();
        } catch (err) {
          console.error(err);
          if (String(err.message).includes('Banned')) {
            alert('You have been banned from clicking.');
            incBtn.disabled = true;
          } else {
            alert('Failed to increment. Try again.');
          }
        } finally {
          incBtn.disabled = false;
        }
      });

      // Name
      const nameForm = document.getElementById('name-form');
      const nameInput = document.getElementById('name-input');
      const nameStatus = document.getElementById('name-status');

      async function loadName() {
        try {
          const { name } = await fetchJSON('/api/name');
          setOnlineState(true);
          if (typeof name === 'string' && name) nameInput.value = name;
        } catch {}
      }
      nameForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = nameInput.value.trim().replace(/\s+/g, ' ');
        if (name.length < 2 || name.length > 32) { nameStatus.textContent = 'Name must be 2–32 characters.'; return; }
        nameStatus.textContent = 'Saving...';
        try {
          await fetchJSON('/api/name', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
          setOnlineState(true);
          nameStatus.textContent = 'Saved ✓';
          refreshLeaderboard();
        } catch (e) { console.error(e); nameStatus.textContent = 'Failed to save name.'; }
        finally { setTimeout(() => (nameStatus.textContent = ''), 2000); }
      });

      // Admin
      async function loadAdminStats() {
        try {
          adminStatus.textContent = 'Loading…';
          const { global_count, leaderboard_size } = await fetchJSON('/api/admin/stats');
          setOnlineState(true);
          adminGcEl.textContent = global_count.toLocaleString();
          adminLbSizeEl.textContent = leaderboard_size.toLocaleString();
          adminStatus.textContent = '';
        } catch (e) { adminStatus.textContent = 'Error: ' + (e.message || e); }
      }

      adminApplySet.addEventListener('click', async () => {
        const val = Math.floor(Number(adminSetValue.value));
        if (!Number.isFinite(val) || val < 0) return alert('Enter a non-negative integer');
        try {
          await fetchJSON('/api/admin/set-count', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ value: val }) });
          await Promise.all([loadAdminStats(), refreshCount()]);
          alert('Count set');
        } catch (e) { alert('Failed: ' + e.message); }
      });

      adminApplyAdd.addEventListener('click', async () => {
        const delta = Math.floor(Number(adminAddDelta.value));
        if (!Number.isFinite(delta) || delta <= 0) return alert('Enter a positive integer');
        try {
          await fetchJSON('/api/admin/add-count', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ delta }) });
          await Promise.all([loadAdminStats(), refreshCount()]);
          adminAddDelta.value = '';
          alert('Added to count');
        } catch (e) { alert('Failed: ' + e.message); }
      });

      adminUserAdd.addEventListener('click', async () => {
        const id = adminUserId.value.trim(); const delta = Math.floor(Number(adminUserDelta.value));
        if (!id) return alert('Enter a user id'); if (!Number.isFinite(delta) || delta <= 0) return alert('Enter a positive integer');
        try {
          await fetchJSON('/api/admin/user-delta', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, delta }) });
          await refreshLeaderboard();
          alert('User clicks increased');
        } catch (e) { alert('Failed: ' + e.message); }
      });

      adminUserRemove.addEventListener('click', async () => {
        const id = adminUserId.value.trim(); const delta = Math.floor(Number(adminUserDelta.value));
        if (!id) return alert('Enter a user id'); if (!Number.isFinite(delta) || delta <= 0) return alert('Enter a positive integer');
        try {
          await fetchJSON('/api/admin/user-delta', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, delta: -delta }) });
          await refreshLeaderboard();
          alert('User clicks decreased');
        } catch (e) { alert('Failed: ' + e.message); }
      });

      adminUserBan.addEventListener('click', async () => {
        const id = adminUserId.value.trim(); if (!id) return alert('Enter a user id');
        const purge = confirm('Also purge this user from the leaderboard?');
        try {
          await fetchJSON('/api/admin/ban', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, banned: true, purge }) });
          await refreshLeaderboard();
          alert('User banned' + (purge ? ' and purged' : ''));
        } catch (e) { alert('Failed: ' + e.message); }
      });

      adminUserUnban.addEventListener('click', async () => {
        const id = adminUserId.value.trim(); if (!id) return alert('Enter a user id');
        try {
          await fetchJSON('/api/admin/ban', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, banned: false, purge: false }) });
          alert('User unbanned');
        } catch (e) { alert('Failed: ' + e.message); }
      });

      (async function init() {
        setOnlineState(navigator.onLine);
        try { const { count } = await fetchJSON('/api/count'); setNumber(count, { animate: false }); } catch {}
        await loadName();
        await refreshLeaderboard();

        // Show admin only if admin in DB
        try {
          const me = await fetchJSON('/api/me');
          if (me?.admin) { adminPanel.hidden = false; await loadAdminStats(); }
          else { adminPanel.hidden = true; }
        } catch { adminPanel.hidden = true; }

        let countTimer, lbTimer;
        const schedule = () => {
          clearInterval(countTimer); clearInterval(lbTimer);
          const countMs = document.hidden ? 5000 : 1000;
          const lbMs    = document.hidden ? 15000 : 5000;
          countTimer = setInterval(refreshCount, countMs);
          lbTimer    = setInterval(refreshLeaderboard, lbMs);
        };
        document.addEventListener('visibilitychange', schedule);
        schedule();
      })();
    </script>
  </body>
</html>
