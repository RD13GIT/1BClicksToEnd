<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Global Counter</title>

    <!-- Odometer -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/odometer@0.4.8/themes/odometer-theme-default.min.css">
    <script src="https://cdn.jsdelivr.net/npm/odometer@0.4.8/odometer.min.js" defer></script>

    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        color-scheme: dark;

        --slots: 8;
        --digit-w: 56px;  /* make slots wider/narrower here */
        --digit-h: 5rem;
        --gap: 12px;
        --border: 2px;
        --panel-pad: 14px;

        --counter-w: calc(var(--slots) * var(--digit-w) + (var(--slots) - 1) * var(--gap));
      }

      html, body { height: 100%; }
      * { box-sizing: border-box; }

      body {
        margin: 0;
        display: grid;
        place-items: center;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue",
          Ubuntu, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        color: #fff;

        /* Grid background */
        background-color: #171717;
        background-image:
          linear-gradient(#202020 1px, transparent 1px),
          linear-gradient(90deg, #202020 1px, transparent 1px);
        background-size: 40px 40px;
      }

      .stage {
        display: grid;
        justify-items: center;
        gap: 28px;
      }

      .title {
        opacity: 0.85;
        font-size: 14px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .counter-wrap {
        position: relative;
        display: inline-block;
        width: var(--counter-w);
        height: var(--digit-h);
      }

      .panel {
        position: absolute;
        inset: calc(-1 * var(--panel-pad));
        background: #242424;
        border-radius: 16px 16px 0 0; /* smooth top corners */
        z-index: 0;
      }

      /* 8 visible slot boxes (always shown) */
      .slots {
        position: absolute;
        inset: 0;
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: var(--digit-w);
        column-gap: var(--gap);
        z-index: 1;
        pointer-events: none;
      }
      .slot {
        width: var(--digit-w);
        height: var(--digit-h);
        background: #191919;
        border: var(--border) solid #7a7a7a;
        border-radius: 8px;
      }

      /* Odometer layer on top, snapped to the same 8 columns */
      .odometer {
        position: relative;
        z-index: 2;
        width: var(--counter-w);
        height: var(--digit-h);
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        font-variant-numeric: tabular-nums;
        user-select: none;
      }
      /* Make the inside a grid so each digit occupies one slot */
      .odometer .odometer-inside {
        display: grid !important;
        grid-auto-flow: column;
        grid-auto-columns: var(--digit-w);
        column-gap: var(--gap);
        justify-content: end;   /* right-align into the rightmost slots */
        align-items: center;
        height: 100%;
      }

      /* Hide formatting marks (commas, etc.) */
      .odometer .odometer-formatting-mark { display: none !important; }

      /* Each digit fills its slot; keep the rolling ribbon inside */
      .odometer .odometer-digit {
        width: var(--digit-w) !important;
        height: var(--digit-h) !important;
        overflow: hidden;
        text-align: center;
        background: transparent !important;
        border: none !important;
      }
      .odometer .odometer-digit-spacer,
      .odometer .odometer-value,
      .odometer .odometer-digit-inner,
      .odometer .odometer-ribbon,
      .odometer .odometer-ribbon-inner {
        height: var(--digit-h) !important;
        line-height: var(--digit-h) !important;
      }

      /* Button outside, no stroke; width matches the panel via JS */
      .cta-button {
        display: block;
        box-sizing: border-box;
        width: auto; /* set by JS */
        padding: 0.9rem 1.2rem;
        background: #242424;
        color: #fff;
        border: none;
        border-radius: 8px;
        font: inherit;
        cursor: pointer;
        text-align: center;
      }
      .cta-button:hover { background: #2a2a2a; }
      .cta-button:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }
    </style>
  </head>
  <body>
    <div class="stage">
      <div class="title">GLOBAL CLICKS</div>

      <div class="counter-wrap">
        <div class="panel" aria-hidden="true"></div>

        <!-- 8 slot boxes (always visible) -->
        <div class="slots" aria-hidden="true">
          <span class="slot"></span><span class="slot"></span><span class="slot"></span><span class="slot"></span>
          <span class="slot"></span><span class="slot"></span><span class="slot"></span><span class="slot"></span>
        </div>

        <!-- Force 8 digits with data-odometer-format -->
        <div
          id="counter"
          class="odometer"
          data-odometer-format="dddddddd"
        >0</div>
      </div>

      <button id="inc" class="cta-button" type="button">+1</button>
    </div>

    <script>
      // Odometer options
      window.odometerOptions = { duration: 1000, animation: 'slide' };

      const counterEl = document.getElementById('counter');
      const incBtn = document.getElementById('inc');

      async function fetchJSON(url, opts) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      async function refresh() {
        try {
          const { count } = await fetchJSON('/api/count');
          // Feed a number; the format string ensures 8 digits with leading zeros.
          counterEl.innerHTML = Number(count);
        } catch (e) {
          console.error('poll error', e);
        }
      }

      // Match button width to the behind panel exactly
      (function sizeButtonToPanel() {
        const panel = document.querySelector('.panel');
        const btn = document.querySelector('.cta-button');
        const target = document.querySelector('.counter-wrap');
        if (!panel || !btn || !target) return;

        const setButtonWidth = () => {
          const w = Math.ceil(panel.getBoundingClientRect().width);
          btn.style.width = w + 'px';
        };

        window.addEventListener('load', setButtonWidth);
        window.addEventListener('resize', setButtonWidth);
        if ('ResizeObserver' in window) {
          const ro = new ResizeObserver(setButtonWidth);
          ro.observe(target);
        }
      })();

      (async function init() {
        await refresh();

        // Poll every 1s; back off to 5s when tab is hidden
        let timer;
        const schedule = () => {
          clearInterval(timer);
          const ms = document.hidden ? 5000 : 1000;
          timer = setInterval(refresh, ms);
        };
        document.addEventListener('visibilitychange', schedule);
        schedule();

        incBtn.addEventListener('click', async () => {
          incBtn.disabled = true;
          try {
            const { count } = await fetchJSON('/api/increment', { method: 'POST' });
            counterEl.innerHTML = Number(count);
          } catch (err) {
            console.error(err);
            alert('Failed to increment. Try again.');
          } finally {
            incBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
